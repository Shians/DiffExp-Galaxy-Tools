<tool id="Rsubread" name="Rsubread Mapping" version="1.0.1">
  <description>
    Produce table of feature counts using Rsubread.
  </description>

  <requirements>
    <requirement type="R-module">edgeR</requirement>
    <requirement type="R-module">limma</requirement>
  </requirements>

  <stdio>
    <exit_code range="1:" level="fatal" description="Tool exception" />
  </stdio>

  <command interpreter="Rscript">
  RSubread.R  $workMode
              $inputFormat
              $refGenome.source
              #if $refGenome.source=="indexed"
                $refGenome.index.fields.path
              #elif $refGenome.source=="history"
                $refGenome.index
              #end if
              $annotation
              $singlePaired.sPaired
              
              #if $singlePaired.sPaired=="single"
                #for $i, $fastq in enumerate($singlePaired.fastq):
                  "fastq::$fastq.label::$fastq.group::$fastq.file"
                #end for
              #elif $singlePaired.sPaired=="paired"
                #for $i, $fastq in enumerate($singlePaired.fastq):
                  "fastq::$fastq.label::$fastq.group::$fastq.pair1::$fastq.pair2"
                #end for
              #end if
              
              $nthreads
              $countsOut
              $geneannoOut
  </command>

  <inputs>
    <param name="workMode" type="select" label="Alignment Algorithm">
      <option value="align">Align</option>
      <option value="subjunc">Subjunc</option>
    </param>
    
    <param name="inputFormat" type="select" label="Input Data Type">
      <option value="gzFASTQ">Gzipped FastQ</option>
      <option value="FASTQ">FastQ</option>
    </param>
    
    <conditional name="refGenome">
      <param name="source" type="select" 
             label="Will you select a reference genome from your history or use 
                    a built-in index?">
        <option value="indexed">Use a built-in index</option>
        <option value="history">Use one from the history</option>
      </param>
      
      <when value="indexed">
        <param name="index" type="select" label="Select a reference genome">
          <options from_data_table="rsubread_indices">
            <filter type="sort_by" column="2"/>
            <validator type="no_options" 
                       message="No indexes are available for the selected input 
                                dataset"/>
          </options>
        </param>
      </when>
      
      <when value="history">
        <param name="index" type="data" format="fasta"
               label="Select the reference genome" />
      </when>
    </conditional>
    
    <param name="annotation" type="select" label="Genome for Feature Counts">
      <option value="mm9">mm9</option>
      <option value="mm10">mm10</option>
      <option value="hg19">hg19</option>
    </param>

    <conditional name="singlePaired">
      <param name="sPaired" type="select" label="Is this library mate-paired?">
        <option value="single">Single-end</option>
        <option value="paired">Paired-end</option>
      </param>

      <when value="single">
        <repeat name="fastq" title="FastQ Files">     
          <param name="label" type="text" label="Sample Label"/>
          <param name="group" type="text" label="Experimental Group"/>
          <param name="file" type="data" format="fastq"/>
        </repeat>
      </when>

      <when value="paired">
        <repeat name="fastq" title="FastQ Pairs">
          <param name="label" type="text" label="Sample Label"/>
          <param name="group" type="text" label="Experimental Group"/>
          <param name="pair1" type="data" format="fastq"/>
          <param name="pair2" type="data" format="fastq"/>
        </repeat>
      </when>

    </conditional>
    
    <param name="nthreads" type="select" label="Number of Processing Threads">
      <option value="1">1</option>
      <option value="2" selected="True">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
      <option value="7">7</option>
      <option value="8">8</option>
      <option value="9">9</option>
      <option value="10">10</option>
      <option value="11">11</option>
      <option value="12">12</option>
      <option value="13">13</option>
      <option value="14">14</option>
      <option value="15">15</option>
      <option value="16">16</option>
    </param>
  </inputs>

  <outputs>
    <data format="tabular" name="countsOut" label="Feature Counts"/>
    <data format="tabular" name="geneannoOut" label="Gene Annotations"/>
  </outputs>

  <help>
  </help>
</tool>
