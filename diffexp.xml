<tool id="diffexp" name="DiffExp" version="0.0.4">
  <description>
      Perform differential expression analysis using the edgeR and limma
      packages
  </description>
  
  <requirements>
      <requirement type="R-module">edgeR</requirement>
      <requirement type="R-module">limma</requirement>
  </requirements>

  <command interpreter="RScript">
      diffexp.R $counts $geneanno $pdfout $top $topNW $plotOptions <!--6-->
                $normalisationOption $wantWeight.weightOption      <!--8-->
                
                #if $filterCPM.filterLowCPM=="yes":
                  $filterCPM['cpmReq'] $filterCPM['sampleReq']
                #else
                  0 0
                #end if                                            <!--10-->
                
                #for $i, $fct in enumerate($factors):
                  factor::$fct.factName::$fct.factLevel
                #end for
  </command>
   
  <inputs>
      <param name="counts" type="data" format="rda" label="Counts Data"/>
      
      <param name="geneanno" type="data" format="rda"
             label="Gene Annotations"/>
      
      <repeat name="factors" title="Factors" min="1" max="5" default="1">
          <param name="factName" type="text" label="Factor Name (No spaces)"
                 help="Eg. Genotype"/>
          <param name="factLevel" type="text" size="100"
                 label="Factor Levels (No spaces)"
                 help="Eg. WT,WT,Mut,Mut,WT"/>
      </repeat>
      
      <conditional name="filterCPM">
          <param name="filterLowCPM" type="select" label="Filter Low CPM">
                 <option value="yes" selected="True">Yes</option>
                 <option value="no">No</option>
          </param>
          <when value="yes">
          <param name="cpmReq" type="float" value="0.5" min="0" max="1"
                 label="Minimum CPM"/>
          <param name="sampleReq" type="integer" value="3" min="0"
                 label="Minimum Samples" 
                 help="Filter out all the genes that do not meet the minimum 
                      CPM in at least this many samples"/>
          </when>
          <when value="no"/>
      </conditional>
      
      <param name="normalisationOption" type="select" 
             label="Normalisation Method">
        <option value="TMM">TMM</option>
        <option value="RLE">RLE</option>
        <option value="upperquartile">Upperquartile</option>
        <option value="none">None (Don't normalise)</option>
      </param>
      
      <conditional name="wantWeight">
        <param name="weightOption" type="select" label="Apply weights"
               display="radio" help="Apply weights if outliers are present">
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </param>
      </conditional>
      
      <param name="plotOptions" type="select" label="Select Plots"
             display="checkboxes" multiple="true">
        <option value="bcv" selected="True">BCV</option>
        <option value="voom" selected="True">voom</option>
        <option value="ma" selected="True">MA</option>
      </param>
  </inputs>
  
  <outputs>
    <data name="pdfout" format="pdf" label="Plots"/>
      
    <data name="top" format="csv" label="Top Expressions">
        <filter>wantWeight['weightOption']=="yes"</filter>
    </data>
        
    <data name="topNW" format="csv"
          label="Top Expressions (no weights)">
          <filter>wantWeight['weightOption']=="no"</filter>
    </data>
  </outputs>
  
  <help>
      Help is on its way!
  </help>
</tool>
