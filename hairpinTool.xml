<tool id="shRNAseq" name="shRNAseq Tool" version="1.0.3">
  <description>
    Analyse hairpin differential expression using edgeR
  </description>
    
  <requirements>
    <requirement type="R-module">edgeR</requirement>
    <requirement type="R-module">limma</requirement>
  </requirements>
  
  <stdio>
    <exit_code range="1" level="fatal" description="Unexpected Error" />
  </stdio>
  
  <command interpreter="RScript">
  hairpintool.R #for $i, $fas in enumerate($fastq):
                  fastq::$fas.file
                #end for
  
                $hairpin $samples 
                  
                #if $positions.option=="yes":
                $positions.barstart $positions.barend
                $positions.hpstart $positions.hpend 
                #else:
                1 5 37 57
                #end if
          
                #if $filterCPM.option=="yes":
                $filterCPM.cpmReq $filterCPM.sampleReq
                #else:
                0 0
                #end if
          
                $fdr $workMode.mode $outFile $outFile.files_path
          
                #if $workMode.mode=="classic":
                  "$workMode.pair1" "$workMode.pair2"
                #else:
                  "$workMode.contrast" $workMode.roast.option
                  #if $workMode.roast.option=="yes":
                    $workMode.roast.hairpinReq
                    $workMode.roast.select.option
                    "$workMode.roast.select.selection"
                  #else:
                    0 0 0
                  #end if
                #end if
          
                
  </command>
  
  <inputs>
    <param name="hairpin" type="data" format="tabular" 
           label="Hairpin Data"/>
    
    <param name="samples" type="data" format="tabular" 
           label="Samples Information"/>
           
    <repeat name="fastq" title="FastQ Files">       
      <param name="file" type="data" format="fastq"/>
    </repeat>
    
    <conditional name="positions">
      <param name="option" type="select" 
             label="Specify Barcode and Hairpin Locations?"
             help="Default Positions: Barcode: 1 to 5, Hairpin: 37 to 57">
        <option value="no" selected="True">No</option>
        <option value="yes">Yes</option>
      </param>
      
      <when value="yes">
        <param name="barstart" type="integer" value="1"
               label="Barcode Starting Position"/>
        <param name="barend" type="integer" value="5"
               label="Barcode Ending Position"/>
        
        <param name="hpstart" type="integer" value="37"
               label="Hairpin Starting Position"/>
           
        <param name="hpend" type="integer" value="57"
               label="Hairpin Ending Position"/>
      </when>
      
      <when value="no"/>
    </conditional>
    
    <conditional name="filterCPM">
      <param name="option" type="select" label="Filter Low CPM?"
       help="Treat hairpins with very low expression as unexpressed and 
       			 filter out to speed up computation">
        <option value="no" selected="True">No</option>
        <option value="yes">Yes</option>
      </param>
      
        <when value="yes">
          <param name="cpmReq" type="float" value="0.5" min="0" max="1"
                 label="Minimum CPM"/>
                 
          <param name="sampleReq" type="integer" value="3" min="0"
                 label="Minimum Samples" 
                 help="Filter out all the genes that do not meet the minimum 
                       CPM in at least this many samples"/>
        </when>
        
        <when value="no"/>
        
    </conditional>
    
    <conditional name="workMode">
      <param name="mode" type="select" label="Analysis Type">
        <option value="classic">Classic Exact Test</option>
        <option value="glm">Generalised Linear Model</option>
      </param>
      
      <when value="classic">
        <param name="pair1" type="text" label="Compare"/>
        <param name="pair2" type="text" label="To"/>
      </when>
      
      <when value="glm">
        <param name="contrast" type="text" size="30"
               label="Contrasts of interest (No spaces)"
               help="Eg. Mut-WT,KD-Control"/>
               
        <conditional name="roast">
          <param name="option" type="select" 
                 label="Perform Gene Level Analysis?"
                 help="Analyse LogFC tendencies for hairpins belonging
                       to the same gene">
            <option value="no">No</option>
            <option value="yes">Yes</option>
          </param>
          
          <when value="yes">
            <param name="hairpinReq" type="integer" value="2" min="2"
                   label="Minimum Hairpins"
                   help="Only genes with at least this many hairpins will
                         be analysed"/>
                         
            <conditional name="select">
              <param name="option" type="select"
                     label="Gene Selection Method">
                <option value="rank">Rank</option>
                <option value="geneID">Gene Identifier</option>
              </param>
              <when value="rank">
                <param name="selection" type="text" value="1:5"
                       label="Ranks of Top Genes to Plot"/>
              </when>
              <when value="geneID">
                <param name="selection" type="text" value=""
                       label="Symbols of Genes to Plot"/>
              </when>
            </conditional>

            
          </when>
          
          <when value="no"/>
        </conditional>
      </when>
    </conditional>
    
    <param name="fdr" type="float" value="0.05" min="0" max="1"
           label="FDR Threshold"
           help="All observations below this threshold will be highlighted
                 in the smear plot"/>
  </inputs>

  <outputs>
    <data format="html" name="outFile" label="shRNAseq Analysis"/>
  </outputs>
  
  <help>
  </help>
</tool>
  
